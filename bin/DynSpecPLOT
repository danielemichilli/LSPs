#!/usr/bin/env python

'''

Dynamic Spectrum Plotter

Written by Daniele Michilli

'''

t0 = 1400  #s
file_name = '/projects/lotaas/test/Daniele/raw/L204720_red/stokes/SAP2/BEAM38/L204720_SAP2_BEAM38.fits'

import numpy as np
import matplotlib as mpl
mpl.use('Agg')
import matplotlib.pyplot as plt
import pyfits
fits = pyfits.open(file_name,memmap=True)
subint_duration = fits['SUBINT'].header['TBIN']*fits['SUBINT'].header['NSBLK']
subint_index = np.int(t0/subint_duration)
total_duration = 432  #s
frame_duration = np.int(36/subint_duration)*12
subint = fits['SUBINT'].data[subint_index:subint_index+frame_duration]['DATA']
N_channels = fits['SUBINT'].header['NCHAN']
N_spectra = frame_duration*fits['SUBINT'].header['NSBLK']
subint = subint.reshape(N_spectra/384,384,N_channels).mean(axis=1)
#subint = subint[:,1:]
subint = subint[:,~np.all(subint == 0, axis=0)]
plt.figure(figsize=(20,10))
plt.xlabel('Time (s)')
plt.ylabel('Frequency (MHz)')
plt.imshow(subint.T,cmap=mpl.cm.hot_r,origin="lower",aspect='auto',interpolation='nearest',extent=[t0,t0+total_duration,119,151])
plt.colorbar()
x_lines = np.linspace(t0+36,t0+36*11,10)
y_lines = np.zeros(x_lines.shape[0])
plt.plot([x_lines,x_lines],[y_lines+118,y_lines+160],'b--')
plt.axis([t0,t0+total_duration,119,151])
plt.savefig('test.png',format='png',bbox_inches='tight')

